<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/admin/styles/layouts/AdminpageLayout}">

<head>
    <title>PaymentHistory</title>
    <link rel="stylesheet" th:href="@{/css/PaymentHistory.css}" type="text/css">
<!--      <link rel="stylesheet" th:href="@{/css/PaymentHistory2.css}" type="text/css">-->
</head>

<section layout:fragment="content">
    <div>
        <div class="payment-header">
            <h2>결제 기록 조회</h2>
        </div>

        <hr>
        <div class="search-container">
            <form>
                <div class="condition-container">

                    <div>

                        <div class="condition-group">
                            <label>
                                <span>조회 기간</span>
                                <input type="date" id="checkStartDate" name="checkStartDate">
                                ~
                                <input type="date" id="checkEndDate" name="checkEndDate">
                            </label>
                        </div>

                        <div class="condition-group date-range">
                            <button type="button" onclick="setDateRange(0)">오늘</button>
                            <button type="button" onclick="setDateRange(7)">1주일</button>
                            <button type="button" onclick="setDateRange(30)">1개월</button>
                            <button type="button" onclick="setDateRange(90)">3개월</button>
                        </div>
                    </div>

                    <div>
<!--                        <label class="button-label"></label>-->
                        <div class="condition-group">
                            <span>기록 검색</span>
                            <label>
                                <select name="searchCondition">
                                    <option value="">검색 조건</option>
                                    <option value="paymentId">결제 번호</option>
                                    <option value="userNumber">회원 번호</option>
                                    <option value="userName">회원 이름</option>
                                    <option value="gameNumber">경기 번호</option>
                                </select>
                                &nbsp;
                                <input type="text" name="searchKeyword">
                            </label>
                        </div>

<!--                        <label class="status-label"></label>-->
                        <div class="condition-group">
                            <span>거래 상태</span>
                            <label>
                                <input type="checkbox" name="paymentStatus" value="completed">
                                결제 완료
                            </label>
                            <label>
                                <input type="checkbox" name="paymentStatus" value="canceled">
                                결제 취소
                            </label>
                            <label>
                                <input type="checkbox" name="paymentStatus" value="refunded">
                                부분 환불
                            </label>
                        </div>
                    </div>
                </div>

                <div class="buttons-container">
                    <button type="submit" class="search-button">검색</button>
                    <button type="reset" class="reset-button">초기화</button>
                </div>
            </form>
        </div>
        <hr>

<!--        <a href="path/to/your/excel/file.xlsx" download class="download-button">Excel 파일 다운로드</a>-->
        <br>

        <table>
            <thead>
            <tr>
                <th></th>
                <th>결제 번호</th>
                <th>거래 일시</th>
                <th>취소 일시</th>
                <th>경기 번호</th>
                <th>회원 번호</th>
                <th>회원 이름</th>
                <th>거래 상태</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${paymentList.isEmpty()}">
                <td colspan="8" style="text-align: center;">
                    등록된 결제 내역이 없습니다.
                </td>
            </tr>

            <tr th:each="payment: ${paymentList}">
                <td>
                    <label><input type="checkbox" name="selectedPayment" value="" /></label>
                </td>
                <td th:text="${payment.paymentNumber}">123</td>
                <td th:text="${payment.transactionDateTime}">2023-00-00</td>
                <td th:text="${payment.cancelDateTime}">2023-00-00</td>
                <td th:text="${payment.gameNumber}">200</td>
                <td th:text="${payment.userId.userId}">10</td>
                <td th:text="${payment.userId.name}">김00</td>
                <td th:text="${payment.paymentStatus}">결제 완료</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<th:block layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        function setDateRange(days) {
            var endDate = new Date();
            var startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            var startDateInput = document.getElementById("checkStartDate");
            var endDateInput = document.getElementById("checkEndDate");

            console.log(startDate)

            startDateInput.value = formatDate(startDate);
            endDateInput.value = formatDate(endDate);
        }

        function formatDate(date) {
            var year = date.getFullYear();
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var day = ("0" + date.getDate()).slice(-2);
            return year + "-" + month + "-" + day;
        }

        function searchPaymentHistory() {
            var checkStartDate = document.getElementById("checkStartDate").value;
            var checkEndDate = document.getElementById("checkEndDate").value;
            var searchCondition = document.querySelector('select[name="searchCondition"]').value;
            var searchKeyword = document.querySelector('input[name="searchKeyword"]').value.toUpperCase();
            var paymentStatuses = document.querySelectorAll('input[name="paymentStatus"]:checked');
            var selectedStatuses = Array.from(paymentStatuses).map(function (status) {
                return status.value;
            });

            var table = document.querySelector("table");
            var rows = table.getElementsByTagName("tr");
            var hasVisibleRows = false;

            for (var i = 1; i < rows.length; i++) {
                var row = rows[i];
                var paymentNumber = row.cells[1].textContent.toUpperCase();
                var gameNumber = row.cells[4].textContent.toUpperCase();
                var userId = row.cells[5].textContent.toUpperCase();
                var paymentStatus = row.cells[7].textContent.toUpperCase();
                var transactionDateTime = row.cells[2].textContent;

                var isVisible = true;

                if (checkStartDate && checkEndDate) {
                    var startDate = new Date(checkStartDate);
                    var endDate = new Date(checkEndDate);
                    var transactionDate = new Date(transactionDateTime);

                    if (transactionDate < startDate || transactionDate > endDate) {
                        isVisible = false;
                    }
                }

                if (searchKeyword && searchCondition) {
                    var targetValue = "";

                    switch (searchCondition) {
                        case "name":
                            targetValue = row.cells[6].textContent.toUpperCase();  // 회원 이름
                            break;
                        case "userNumber":
                            targetValue = userId;
                            break;
                        case "gameNumber":
                            targetValue = gameNumber;
                            break;
                    }

                    if (!targetValue.includes(searchKeyword)) {
                        isVisible = false;
                    }
                }

                if (selectedStatuses.length > 0) {
                    if (!selectedStatuses.includes(paymentStatus.toLowerCase())) {
                        isVisible = false;
                    }
                }

                if (isVisible) {
                    row.style.display = "table-row";
                } else {
                    row.style.display = "none";
                }
            }
        }

        function resetForm() {
            var searchCondition = document.querySelector('select[name="searchCondition"]');
            searchCondition.selectedIndex = 0;

            var searchKeyword = document.querySelector('input[name="searchKeyword"]');
            searchKeyword.value = "";

            var startDateInput = document.getElementById("checkStartDate");
            var endDateInput = document.getElementById("checkEndDate");

            startDateInput.value = "";
            endDateInput.value = "";

            var paymentStatuses = document.querySelectorAll('input[name="paymentStatus"]:checked');
            Array.from(paymentStatuses).forEach(function(status) {
                status.checked = false;
            });

            searchPaymentHistory();
        }

        document.querySelector("form").addEventListener("submit", function(event) {
            event.preventDefault();
            searchPaymentHistory();
        });

        // document.querySelector(".reset-button").addEventListener("click", function() {
        //     resetForm();
        // });
    </script>

</th:block>


</html>

<body>



